name: tests

on:
  pull_request:
  push:
    branches: [ master ]

jobs:
  generic-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Setup java
        uses: actions/setup-java@v4
        with:
          # Not using variables to allow running from forks
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Run generic tests
        run: ./gradlew json-schema:test --no-daemon

      - name: Upload test execution data
        uses: actions/upload-artifact@v4
        with:
          name: generic-tests-exec
          path: build/jacoco

  integration-tasks-list:
    runs-on: ubuntu-latest
    outputs:
      integration-tasks: ${{ steps.integration-tasks.outputs.integration-tasks }}
    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Trigger Gradle download
        run: ./gradlew help -q

      - name: Get JSON integration tasks
        id: integration-tasks
        run: |
          TASKS=$(./gradlew integrationTasksArray -q --console=plain)
          echo "integration-tasks=$TASKS" >> "$GITHUB_OUTPUT"

  integration-tasks-execution:
    needs: integration-tasks-list
    runs-on: ubuntu-latest
    name: ${{ matrix.integration-task }}

    strategy:
      matrix:
        integration-task: ${{ fromJSON(needs.integration-tasks-list.outputs.integration-tasks) }}

    steps:
      - uses: actions/checkout@v4
      - name: Setup java
        uses: actions/setup-java@v4
        with:
          # Not using variables to allow running from forks
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Gradle integration tests
        run: ./gradlew ${{ matrix.integration-task }} --no-daemon

      - name: Sanitize name (replace colons)
        id: sanitize
        run: |
          sanitizedName="${{ matrix.integration-task }}"
          sanitizedName="${sanitizedName//:/_}"
          echo "sanitizedName=$sanitizedName" >> "$GITHUB_OUTPUT"

      - name: Upload test execution data
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.sanitize.outputs.sanitizedName }}-tests-exec
          path: |
            lib/build/jacoco
            providers/*/build/jacoco

  report:
    needs: [generic-tests, integration-tasks-execution]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Setup java
        uses: actions/setup-java@v4
        with:
          # Not using variables to allow running from forks
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: wrapper

      - name: Download test execution data
        uses: actions/download-artifact@v4

      - name: Get exec data up one level
        run: find lib/build/jacoco -path 'lib/build/jacoco/*/*' -execdir mv -t ../ {} +

      - name: Gradle jacoco report
        run: ./gradlew jacocoTestReport --no-daemon

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: report-output
          path: |
            lib/build/classes
            lib/build/generated
            lib/build/jacoco
            lib/build/reports
            lib/build/test-results
            providers/*/build/classes
            providers/*/build/generated
            providers/*/build/jacoco
            providers/*/build/reports
            providers/*/build/test-results
